# Скрипт импорта памятников через CLI

Для импорта памятников из Excel файла **через командную строку** (без админ-панели), используй скрипт `/backend/scripts/import-monuments.js`.

## Установка зависимостей

В backend папке должны быть установлены зависимости:
```bash
cd backend
npm install drizzle-orm postgres xlsx dotenv
```

## Использование

### Базовая команда
```bash
node backend/scripts/import-monuments.js <тип> <путь-к-файлу>
```

### Параметры

| Параметр | Значение | Описание |
|----------|----------|---------|
| `<тип>` | single | Одиночные памятники |
| | double | Двойные памятники |
| | composite | Составные памятники |
| `<путь-к-файлу>` | строка | Полный или относительный путь к файлу .xlsx |

### Примеры

**Импорт одиночных памятников:**
```bash
node backend/scripts/import-monuments.js single "Памятники1.xlsx"
```

**Импорт двойных памятников:**
```bash
node backend/scripts/import-monuments.js double "Памятники_двойные.xlsx"
```

**Импорт составных памятников:**
```bash
node backend/scripts/import-monuments.js composite "Составные.xlsx"
```

**С полным путем:**
```bash
node backend/scripts/import-monuments.js single "C:\Users\user\Downloads\Памятники1.xlsx"
```

## Требования к файлу

### Структура Excel файла

Каждый тип памятников ищет определенный лист в файле:

**Одиночные и Двойные:** должен быть лист с названием "Одиночные" или "Двойные"
**Составные:** использует первый доступный лист

### Обязательные колонки

| Колонка | Тип | Пример |
|---------|-----|--------|
| Модель | строка | "photo_123.jpg" |

### Опциональные колонки

| Колонка | Описание |
|---------|---------|
| Наличие товара | "в наличии" или "под заказ" |
| Стела | высота стелы (для одиночных) |
| Тумба | высота тумбы (для одиночных) |
| Тумба2 | вторая тумба (если есть) |
| Цветник | размер цветника |
| Общая высота в см | общая высота памятника |
| Хит продаж | "да" или "нет" |
| Популярные товары | "да" или "нет" |
| Цена в бел. руб | базовая цена |
| Цена в бел.руб. от | цена (для составных) |
| Скидка % | размер скидки |
| Цена со СКИДКОЙ в бел.руб | финальная цена со скидкой |
| Размер в см. Д/Ш/В | размеры (для составных) |

## Вывод скрипта

Скрипт выводит подробный отчет:

```
════════════════════════════════════════════════════════════════════════════════
📌 ИМПОРТ: Одиночные памятники
════════════════════════════════════════════════════════════════════════════════

📊 Найдено листов в файле: 3
📋 Листы: Одиночные, Двойные, Составные

📄 Обрабатываем лист: "Одиночные"
📊 Найдено строк данных: 150

✅ Подготовлено памятников: 150/150

🔄 Загружаю существующие памятники из БД...
   Найдено 100 существующих памятников

   📝 Обновляю: "Памятник Орёл" (ID: 42)
   ✨ Создаю: "Новый памятник"
   ...

════════════════════════════════════════════════════════════════════════════════
📊 РЕЗУЛЬТАТЫ ИМПОРТА:
════════════════════════════════════════════════════════════════════════════════
✨ Создано памятников: 45
📝 Обновлено памятников: 105
⏭️  Всего обработано: 150

📋 Примеры обработанных памятников:
────────────────────────────────────────────────────────────────────────────────

1. Памятник Орёл
   Статус: 📝 ОБНОВЛЕН
   Slug: pamyatnik-orel
   Изображение: /Памятники/Одиночные/800x800/photo_123.jpg
   Высота: 130 см
   Цена: 18500 (было 20000)
   Наличие: в наличии
   Хит: ✅, Популярный: ❌

════════════════════════════════════════════════════════════════════════════════
✅ ИМПОРТ ЗАВЕРШЕН УСПЕШНО!
════════════════════════════════════════════════════════════════════════════════
```

## Переменные окружения

Скрипт требует переменную `DATABASE_URL` в файле `.env.local`:

```env
DATABASE_URL=postgresql://user:password@localhost:5432/monuments_db
```

## UPSERT логика

Скрипт использует эту логику для предотвращения дубликатов:

1. **Поиск по slug** - памятник ищется по сгенерированному slug из названия
2. **Если не найден - поиск по name** - ищется по полному названию
3. **Если найден** - память обновляется (UPDATE)
4. **Если не найден** - памятник создается (INSERT)

## Обработка ошибок

Если есть ошибки в строках:
- Скрипт продолжит обработку остальных строк
- Выведет список ошибок в конце
- Все корректные памятники будут импортированы

Пример вывода ошибок:
```
⚠️  Ошибки при обработке (3):
   - Строка 15: Не найден столбец "Цена"
   - Строка 28: Некорректное значение цены
   - Строка 42: Дублирующееся название
```

## Часто используемые команды

```bash
# Импорт из домашней папки
node backend/scripts/import-monuments.js single ~/Downloads/monuments.xlsx

# Импорт со специальными символами в имени файла
node backend/scripts/import-monuments.js double "Памятники (версия 2).xlsx"

# Импорт из другой директории
cd backend && node scripts/import-monuments.js single "../data/monuments.xlsx"
```

## Сравнение: админ-панель vs скрипт

| Функция | Админ-панель | Скрипт CLI |
|---------|-------------|-----------|
| Веб-интерфейс | ✅ | ❌ |
| Требует аутентификации | ✅ | ❌ |
| Автоматический бэкап | ✅ | ❌ |
| Визуальный отчет | ✅ | ✅ |
| Работает без браузера | ❌ | ✅ |
| Быстрее для больших файлов | ❌ | ✅ |
| Подходит для фона | ❌ | ✅ |

## Совет

- Для обычного использования используй **админ-панель** (`/admin/import`)
- Для автоматизации и больших файлов используй **скрипт CLI**
- Оба способа используют одинаковую логику UPSERT
